<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Pomodoro Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Custom styles */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Light gray background */
            transition: background-color 0.3s ease; /* Smooth transition for flash */
        }
        /* Style for the timeline blocks */
        .timeline-block {
            height: 48px; border-radius: 0.25rem; margin-right: 4px; display: inline-flex;
            flex-direction: column; align-items: center; justify-content: center; color: #4b5563;
            font-size: 0.75rem; padding: 4px 8px; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            transition: background-color 0.3s ease; white-space: nowrap; overflow: hidden;
            text-overflow: ellipsis; max-width: 150px; text-align: center;
        }
        .timeline-block-time { font-size: 0.65rem; color: #6b7280; margin-top: 2px; }
        .timeline-work { background-color: #fef08a; } .timeline-relax { background-color: #fecaca; }
        .timeline-free { background-color: #bfdbfe; } .timeline-custom { background-color: #e9d5ff; }

        .selected-button { outline: 2px solid #3b82f6; outline-offset: 2px; }

        .todo-item { display: flex; align-items: center; padding: 8px 0; border-bottom: 1px solid #e5e7eb; }
        .todo-item input[type="checkbox"] { margin-right: 8px; flex-shrink: 0; } .todo-item span { flex-grow: 1; outline: none; word-break: break-word; }
        .todo-item button { margin-left: 8px; color: #ef4444; background: none; border: none; cursor: pointer; padding: 4px; border-radius: 0.25rem; flex-shrink: 0; }
        .todo-item button:hover { background-color: #fee2e2; }

        #timeline::-webkit-scrollbar { height: 8px; }
        #timeline::-webkit-scrollbar-track { background: #e5e7eb; border-radius: 4px; }
        #timeline::-webkit-scrollbar-thumb { background: #9ca3af; border-radius: 4px; }
        #timeline::-webkit-scrollbar-thumb:hover { background: #6b7280; }

        #date-selector { padding: 4px 8px; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.875rem; cursor: pointer; }
        #date-selector:hover { border-color: #9ca3af; }
        #date-activity-indicator { font-size: 1.2rem; line-height: 1; color: #3b82f6; margin-left: 5px; display: inline-block; vertical-align: middle; min-width: 10px; text-align: center; }

        .add-time-btn {
             background-color: #e5e7eb; color: #374151;
             padding: 22px 12px; /* Increased vertical padding */
             border-radius: 0.375rem; transition: background-color 0.15s ease-in-out;
             width: 100%;
             text-align: center;
        }
        .add-time-btn:hover { background-color: #d1d5db; }

        .timer-active { background-color: #bfdbfe !important; transition: background-color 0.3s ease; }

        /* NEW: Style for screen flash */
        .screen-flash {
             background-color: #FF4136 !important; /* Bright red - CHANGE THIS COLOR IF NEEDED */
        }

        /* NEW: Alarm toggle style */
        #alarm-toggle {
            background: none; border: none; cursor: pointer; font-size: 1.5rem; padding: 0 5px; vertical-align: middle; color: #6b7280;
        }
        #alarm-toggle.enabled { color: #3b82f6; }

        /* NEW: Styles for split reset/stop buttons */
        .control-button-small {
            padding: 10px 15px; /* Adjust padding */
            font-size: 1rem; /* Adjust font size */
            font-weight: 600;
            border-radius: 0.375rem;
            transition: background-color 0.15s ease-in-out;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            color: white;
            flex: 1; /* Make buttons share space */
            text-align: center;
        }

    </style>
</head>
<body class="p-4 md:p-8">

    <audio id="alarm-sound" preload="auto">
        <source src="data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU..." type="audio/wav"> <source src="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA" type="audio/wav">
        Your browser does not support the audio element.
    </audio>

    <div class="max-w-screen-xl mx-auto bg-white rounded-lg shadow-lg p-6">

        <div class="mb-6 border-b pb-4">
            <div class="flex justify-between items-center mb-2">
                <h2 class="text-lg font-semibold text-gray-700">
                    Activity Timeline for: <span id="selected-date-display" class="font-bold text-blue-600"></span>
                </h2>
                <div>
                    <input type="date" id="date-selector">
                    <span id="date-activity-indicator" title="Indicates if data exists for this date"></span> </div>
            </div>
            <div id="timeline" class="w-full bg-gray-100 p-2 rounded overflow-x-auto whitespace-nowrap min-h-[65px]">
                </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">

            <div class="md:col-span-2 bg-gray-50 p-4 rounded-lg border border-gray-200">
                <div class="flex flex-col sm:flex-row gap-4">
                    <div id="timer-display-area" class="flex-1 text-center bg-white p-4 rounded-lg shadow-sm border border-gray-100 transition-colors duration-300">
                        <div id="activity-display" class="text-xl font-semibold mb-1 text-gray-800 capitalize min-h-[28px]">
                            </div>
                        <div id="start-time-display" class="text-sm text-gray-500 mb-2 h-5"></div>
                        <div id="countdown" class="text-8xl font-bold mb-4 text-blue-600">25:00</div>

                        <div class="flex gap-4 mt-8">
                            <div class="flex-1 flex flex-col gap-2">
                                <button id="start-stop-btn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-11 px-6 rounded-lg transition duration-150 ease-in-out shadow text-5xl">
                                    Start
                                </button>
                                <div class="flex gap-2 mt-2">
                                    <button id="reset-btn" class="control-button-small bg-gray-500 hover:bg-gray-600">
                                        Reset
                                    </button>
                                    <button id="stop-log-btn" class="control-button-small bg-yellow-500 hover:bg-yellow-600">
                                        Stop & Log
                                    </button>
                                </div>
                            </div>
                            <div class="flex flex-col gap-2 w-28">
                                <button class="add-time-btn font-bold text-2xl" data-add-time="60">+1m</button>
                                <button class="add-time-btn font-bold text-2xl" data-add-time="180">+3m</button>
                                <button class="add-time-btn font-bold text-2xl" data-add-time="300">+5m</button>
                           </div>
                        </div>
                    </div>

                    <div class="flex-shrink-0 bg-white p-4 rounded-lg shadow-sm border border-gray-100 sm:w-48"> {/* Increased width slightly */}
                        <div class="flex justify-between items-center mb-2"> {/* NEW: Flex container for heading and toggle */}
                            <h3 class="font-semibold text-gray-700">Duration</h3>
                             {/* NEW: Alarm Toggle Button */}
                             <button id="alarm-toggle" title="Toggle Alarm Sound">
                                 <span class="icon-muted">ðŸ”ˆ</span>
                                 <span class="icon-active" style="display: none;">ðŸ”Š</span>
                            </button>
                        </div>
                        <div id="time-intervals" class="space-y-2">
                            <button data-time="300" class="w-full text-left p-2 rounded hover:bg-gray-100 transition duration-150 ease-in-out">5 min</button>
                            <button data-time="600" class="w-full text-left p-2 rounded hover:bg-gray-100 transition duration-150 ease-in-out">10 min</button>
                            <button data-time="900" class="w-full text-left p-2 rounded hover:bg-gray-100 transition duration-150 ease-in-out">15 min</button>
                            <button data-time="1200" class="w-full text-left p-2 rounded hover:bg-gray-100 transition duration-150 ease-in-out">20 min</button>
                            <button data-time="1500" class="w-full text-left p-2 rounded hover:bg-gray-100 transition duration-150 ease-in-out selected-button">25 min</button>
                            <button data-time="1800" class="w-full text-left p-2 rounded hover:bg-gray-100 transition duration-150 ease-in-out">30 min</button>
                            <button data-time="2700" class="w-full text-left p-2 rounded hover:bg-gray-100 transition duration-150 ease-in-out">45 min</button>
                            <button data-time="3600" class="w-full text-left p-2 rounded hover:bg-gray-100 transition duration-150 ease-in-out">60 min</button>
                        </div>
                    </div>
                </div>

                <div class="mt-4 bg-white p-4 rounded-lg shadow-sm border border-gray-100">
                    <h3 class="font-semibold mb-2 text-gray-700">Activity Type</h3>
                    <div id="activity-types" class="flex flex-wrap gap-2">
                        <button data-type="work" class="bg-yellow-200 hover:bg-yellow-300 text-yellow-800 font-medium py-2 px-4 rounded-lg transition duration-150 ease-in-out selected-button">Work</button>
                        <button data-type="relax" class="bg-red-200 hover:bg-red-300 text-red-800 font-medium py-2 px-4 rounded-lg transition duration-150 ease-in-out">Relax</button>
                        <button data-type="free" class="bg-blue-200 hover:bg-blue-300 text-blue-800 font-medium py-2 px-4 rounded-lg transition duration-150 ease-in-out">Free</button>
                        <button data-type="custom" class="bg-purple-200 hover:bg-purple-300 text-purple-800 font-medium py-2 px-4 rounded-lg transition duration-150 ease-in-out">Custom</button>
                    </div>
                    <div class="mt-3">
                         <label for="custom-activity-name" class="block text-sm font-medium text-gray-600 mb-1">Custom Activity Name:</label>
                         <input type="text" id="custom-activity-name" placeholder="e.g., Planning, Reading" class="p-2 border border-gray-300 rounded-lg w-full focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>
            </div>

            <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                <h3 class="font-semibold mb-3 text-gray-700">What comes to mind?</h3>
                <div id="todo-list" class="mb-3 max-h-60 overflow-y-auto pr-2">
                    </div>
                <div class="flex gap-2">
                    <input type="text" id="new-todo-input" placeholder="Add a quick thought..." class="flex-grow p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    <button id="add-todo-btn" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 ease-in-out">Add</button>
                </div>
            </div>
        </div>

        <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
            <h2 class="text-lg font-semibold mb-2 text-gray-700">Notes</h2>
            <textarea id="notes-area" rows="6" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="Write your notes here for the selected date..."></textarea>
        </div>

    </div>

    <script>
        // --- DOM Elements ---
        const timelineDiv = document.getElementById('timeline');
        const activityDisplay = document.getElementById('activity-display');
        const startTimeDisplay = document.getElementById('start-time-display');
        const countdownDisplay = document.getElementById('countdown');
        const startStopBtn = document.getElementById('start-stop-btn');
        const resetBtn = document.getElementById('reset-btn');
        const stopLogBtn = document.getElementById('stop-log-btn'); // NEW: Stop & Log button
        const timeIntervalsDiv = document.getElementById('time-intervals');
        const activityTypesDiv = document.getElementById('activity-types');
        const customActivityNameInput = document.getElementById('custom-activity-name');
        const notesArea = document.getElementById('notes-area');
        const todoListDiv = document.getElementById('todo-list');
        const newTodoInput = document.getElementById('new-todo-input');
        const addTodoBtn = document.getElementById('add-todo-btn');
        const dateSelector = document.getElementById('date-selector');
        const selectedDateDisplay = document.getElementById('selected-date-display');
        const timerDisplayArea = document.getElementById('timer-display-area');
        const bodyElement = document.body; // NEW: Body element for flashing
        const alarmSound = document.getElementById('alarm-sound'); // NEW: Alarm sound element
        const alarmToggleBtn = document.getElementById('alarm-toggle'); // NEW: Alarm toggle button
        const dateActivityIndicator = document.getElementById('date-activity-indicator'); // NEW: Date activity indicator span

        // --- State Variables ---
        let timerInterval = null;
        let totalSeconds = 1500; // Default duration
        let currentSeconds = totalSeconds;
        let isRunning = false;
        let currentActivity = 'work'; // Default activity
        let currentTimerStartTime = null; // Stores the actual Date object when timer starts
        let selectedDate = getTodayDateString();
        let completedActivities = []; // For the selected date
        let todos = []; // For the selected date
        let notes = ''; // For the selected date
        let customActivityName = ''; // For the selected date
        let isAlarmEnabled = true; // NEW: Alarm state
        let datesWithActivity = []; // NEW: List of dates with any saved activity (for marker)
        let audioContextUnlocked = false; // NEW: Track if user interaction allowed audio

        // --- Constants ---
        const ACTIVITY_COLORS = { work: 'timeline-work', relax: 'timeline-relax', free: 'timeline-free', custom: 'timeline-custom' };
        const LOCAL_STORAGE_PREFIX = 'pomodoroAppState_'; // Per-date state
        const GLOBAL_STATE_KEY = 'pomodoroGlobalState'; // Global settings

        // --- Date Helper Functions ---
        function getTodayDateString() { const today = new Date(); const year = today.getFullYear(); const month = String(today.getMonth() + 1).padStart(2, '0'); const day = String(today.getDate()).padStart(2, '0'); return `${year}-${month}-${day}`; }
        function formatDateForDisplay(dateString) { const date = new Date(dateString + 'T00:00:00'); return date.toLocaleDateString(undefined, { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }); }
        function formatTimeForDisplay(date) { if (!date) return ''; return date.toLocaleTimeString(undefined, { hour: '2-digit', minute: '2-digit' }); }

        // --- Timer Functions ---
        function formatTime(seconds) { const displaySeconds = Math.max(0, seconds); const mins = Math.floor(displaySeconds / 60); const secs = displaySeconds % 60; return `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`; }
        function updateDisplay() {
            countdownDisplay.textContent = formatTime(currentSeconds);
            let displayActivityName = currentActivity;
            if (currentActivity === 'custom') {
                const customName = customActivityNameInput.value.trim();
                displayActivityName = customName ? customName : 'Custom';
            } else {
                displayActivityName = currentActivity.charAt(0).toUpperCase() + currentActivity.slice(1);
            }
            activityDisplay.textContent = displayActivityName;
            activityDisplay.title = displayActivityName; // Tooltip for long names
            startTimeDisplay.textContent = isRunning && currentTimerStartTime ? `Started at: ${formatTimeForDisplay(currentTimerStartTime)}` : '';
        }

        // NEW: Function to attempt unlocking audio context
        function unlockAudio() {
            if (!audioContextUnlocked && alarmSound.paused) {
                alarmSound.play().then(() => {
                    alarmSound.pause();
                    audioContextUnlocked = true;
                    console.log("Audio context unlocked.");
                }).catch(error => {
                    console.warn("Audio unlock failed (likely needs more user interaction):", error);
                    // Optional: Provide feedback to the user that sound might not work yet
                });
            }
        }


        function stopTimer(completed = false) {
            clearInterval(timerInterval);
            timerInterval = null;
            isRunning = false;
            startStopBtn.textContent = 'Start';
            startStopBtn.classList.remove('bg-red-500', 'hover:bg-red-600');
            startStopBtn.classList.add('bg-blue-500', 'hover:bg-blue-600');
            timerDisplayArea.classList.remove('timer-active');

            if (completed) {
                 // NEW: Flash screen
                 bodyElement.classList.add('screen-flash');
                 setTimeout(() => {
                     bodyElement.classList.remove('screen-flash');
                 }, 3000); // Flash duration: 3 seconds

                 // NEW: Play sound if enabled
                 if (isAlarmEnabled) {
                     alarmSound.currentTime = 0; // Rewind sound
                     alarmSound.play().catch(e => console.error("Error playing sound:", e));
                 }

                // Log the activity only if the timer completed naturally AND duration was > 0
                if (totalSeconds > 0) {
                    // Pass totalSeconds as the actual duration when timer completes naturally
                    addActivityToTimeline(currentActivity, totalSeconds, currentTimerStartTime);
                }
                currentTimerStartTime = null; // Reset start time for next run
                currentSeconds = totalSeconds; // Reset countdown for next run
                updateDisplay(); // Update display to show full time again
            } else {
                // If stopped manually (not reset), keep the start time displayed until reset
                // startTimeDisplay.textContent = ''; // Don't clear start time display here
            }
             // Always update display after stopping, even if not completed
            updateDisplay();
        }

        function startTimer() {
            if (isRunning) return;
            // Ensure audio context is ready (important for some browsers)
            unlockAudio();

            if (currentSeconds <= 0) { // If timer was at 00:00, reset to full duration
                currentSeconds = totalSeconds;
            }

            // Validation for custom activity name
            if (currentActivity === 'custom' && !customActivityNameInput.value.trim()) {
                alert("Please enter a name for the custom activity before starting.");
                customActivityNameInput.focus();
                customActivityNameInput.classList.add('border-red-500', 'ring-red-500');
                setTimeout(() => {
                    customActivityNameInput.classList.remove('border-red-500', 'ring-red-500');
                }, 2000);
                return;
            }

            isRunning = true;
            if (!currentTimerStartTime) { // Only set a new start time if it wasn't already set (e.g., after pausing)
                currentTimerStartTime = new Date();
            }

            startStopBtn.textContent = 'Pause';
            startStopBtn.classList.remove('bg-blue-500', 'hover:bg-blue-600');
            startStopBtn.classList.add('bg-red-500', 'hover:bg-red-600');
            timerDisplayArea.classList.add('timer-active');
            updateDisplay(); // Update display immediately

            timerInterval = setInterval(() => {
                currentSeconds--;
                updateDisplay();
                if (currentSeconds < 0) { // Use < 0 to ensure the 00:00 state is shown before stopping
                    stopTimer(true); // Timer finished naturally
                    console.log("Timer finished!");
                }
            }, 1000);
        }

        function resetTimer() {
            stopTimer(false); // Stop without marking as completed or logging
            currentTimerStartTime = null; // Clear the start time
            currentSeconds = totalSeconds; // Reset countdown to full duration
            timerDisplayArea.classList.remove('timer-active'); // Ensure active style is removed
            updateDisplay(); // Update display to show full time
            console.log("Timer reset.");
        }

        // NEW: Function to stop the timer and log the elapsed time
        function stopAndLogTimer() {
            if (!isRunning) {
                console.log("Timer not running, cannot stop and log.");
                return; // Do nothing if timer isn't running
            }

            const elapsedSeconds = totalSeconds - currentSeconds; // Calculate time spent
            // Ensure elapsed time is not negative if timer went past 0 somehow
            const actualDuration = Math.max(0, elapsedSeconds);

            stopTimer(false); // Stop the interval, don't trigger completion effects

            if (actualDuration > 0 && currentTimerStartTime) {
                addActivityToTimeline(currentActivity, actualDuration, currentTimerStartTime);
                console.log(`Logged ${formatDurationLabel(actualDuration)} of ${currentActivity}.`);
            } else {
                console.log("No time elapsed or timer not started, nothing logged.");
            }

            // Reset timer state for the next run
            currentTimerStartTime = null;
            currentSeconds = totalSeconds;
            updateDisplay();
        }

        function addTimeToTimer(secondsToAdd) {
            if (currentSeconds >= 0) { // Allow adding time even when paused or at 00:00
                currentSeconds += secondsToAdd;
                // If timer wasn't running but had reached 0, adding time means it should now show > 0
                if (!isRunning && currentSeconds > 0 && countdownDisplay.textContent === "00:00") {
                     currentTimerStartTime = null; // Clear start time as it's effectively reset
                }
                 // Also adjust totalSeconds if the timer is NOT running, so the *next* full run uses the extended time.
                if (!isRunning) {
                    totalSeconds += secondsToAdd;
                     // Update the selected button visually
                     updateButtonSelection(timeIntervalsDiv, `[data-time="${totalSeconds}"]`);
                     // If no exact match, deselect all duration buttons
                     if (!timeIntervalsDiv.querySelector(`[data-time="${totalSeconds}"]`)) {
                         updateButtonSelection(timeIntervalsDiv, null); // Deselect all
                     }
                     saveGlobalState(); // Save the new default duration
                }
                updateDisplay();
            }
        }

        // --- Timeline Functions ---

        // NEW: Helper to format duration label more dynamically
        function formatDurationLabel(seconds) {
            if (seconds < 60) {
                return `${seconds}s`;
            }
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            if (mins < 60) { // Less than an hour
                 return secs > 0 ? `${mins}m ${secs}s` : `${mins}m`;
            }
            // For longer durations, just show rounded minutes for simplicity in the block
            return `${Math.round(seconds / 60)}m`;
        }

        function addActivityToTimeline(activityType, actualDurationSeconds, startTimeDate) {
            let activityName = activityType;
            if (activityType === 'custom') {
                activityName = customActivityNameInput.value.trim() || 'Custom'; // Use saved custom name if available
            } else {
                activityName = activityType.charAt(0).toUpperCase() + activityType.slice(1);
            }

            // Use the actual duration for the label
            const durationLabel = formatDurationLabel(actualDurationSeconds);

            const activityData = {
                type: activityType, // 'work', 'relax', 'free', 'custom'
                name: activityName, // Actual name displayed (could be custom)
                durationLabel: durationLabel, // Formatted duration string (e.g., "25m", "12m 3s")
                actualDuration: actualDurationSeconds, // Store raw seconds
                startTime: startTimeDate ? startTimeDate.toISOString() : new Date().toISOString() // Store start time as ISO string
            };

            completedActivities.push(activityData);
            renderTimeline();
            saveStateForDate(selectedDate); // Save state for the current date
        }

        function renderTimeline() {
            timelineDiv.innerHTML = ''; // Clear current timeline
            if (completedActivities.length === 0) {
                timelineDiv.innerHTML = `<span class="text-gray-500 italic px-2">No activities logged for ${formatDateForDisplay(selectedDate)}.</span>`;
            } else {
                // Sort activities by their start time before rendering
                completedActivities.sort((a, b) => new Date(a.startTime) - new Date(b.startTime));

                completedActivities.forEach(activity => {
                    const block = document.createElement('div');
                    block.classList.add('timeline-block', ACTIVITY_COLORS[activity.type] || 'bg-gray-300'); // Fallback color

                    const startTimeObj = new Date(activity.startTime);
                    const formattedStartTime = formatTimeForDisplay(startTimeObj);

                    // Display name and the calculated duration label
                    block.innerHTML = `
                        <span>${activity.name} (${activity.durationLabel})</span>
                        <span class="timeline-block-time">${formattedStartTime}</span>
                    `;
                    block.title = `${activity.name} (${activity.durationLabel}) - Started: ${formattedStartTime}`; // Tooltip

                    timelineDiv.appendChild(block);
                });
                 // Scroll to the end of the timeline
                timelineDiv.scrollLeft = timelineDiv.scrollWidth;
            }
        }

        // --- To-Do List Functions ---
        function renderTodos() {
            todoListDiv.innerHTML = '';
            if (todos.length === 0) {
                todoListDiv.innerHTML = '<span class="text-gray-500 italic px-1">No quick thoughts added for this date.</span>';
            } else {
                todos.forEach((todo, index) => {
                    const todoItem = document.createElement('div');
                    todoItem.classList.add('todo-item');

                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.checked = todo.completed;
                    checkbox.id = `todo-${index}`; // Add id for label association
                    checkbox.addEventListener('change', () => toggleTodoCompletion(index));

                    const textSpan = document.createElement('label'); // Use label for better accessibility
                    textSpan.htmlFor = `todo-${index}`; // Associate label with checkbox
                    textSpan.textContent = todo.text;
                    textSpan.style.textDecoration = todo.completed ? 'line-through' : 'none';
                    textSpan.style.color = todo.completed ? '#9ca3af' : 'inherit';
                    textSpan.style.cursor = 'pointer'; // Indicate label is clickable
                    textSpan.classList.add('flex-grow', 'ml-2'); // Adjust spacing

                    const deleteBtn = document.createElement('button');
                    deleteBtn.innerHTML = '&times;'; // Use HTML entity for 'x'
                    deleteBtn.title = "Delete item";
                    deleteBtn.addEventListener('click', () => deleteTodoItem(index));

                    todoItem.appendChild(checkbox);
                    todoItem.appendChild(textSpan);
                    todoItem.appendChild(deleteBtn);
                    todoListDiv.appendChild(todoItem);
                });
            }
        }
        function addTodoItem() {
            const text = newTodoInput.value.trim();
            if (text) {
                todos.push({ text: text, completed: false });
                newTodoInput.value = ''; // Clear input field
                renderTodos();
                saveStateForDate(selectedDate); // Save state after adding
            }
        }
        function toggleTodoCompletion(index) {
            if (todos[index]) {
                todos[index].completed = !todos[index].completed;
                renderTodos();
                saveStateForDate(selectedDate); // Save state after toggling
            }
        }
        function deleteTodoItem(index) {
            todos.splice(index, 1); // Remove item from array
            renderTodos();
            saveStateForDate(selectedDate); // Save state after deleting
        }

        // --- Persistence (localStorage) ---

        // NEW: Separate function to save global state
        function saveGlobalState() {
             const globalState = {
                 selectedTime: totalSeconds,
                 selectedActivity: currentActivity,
                 isAlarmEnabled: isAlarmEnabled, // Save alarm toggle state
                 datesWithActivity: datesWithActivity // Save dates with activity
             };
             try {
                 localStorage.setItem(GLOBAL_STATE_KEY, JSON.stringify(globalState));
             } catch (e) {
                 console.error("Error saving global state:", e);
                 // Avoid alerting here as it might be too frequent
             }
        }


        function saveStateForDate(dateString) {
            notes = notesArea.value; // Update notes state variable before saving
            customActivityName = customActivityNameInput.value; // Update custom name state variable

            const stateForDate = {
                completedActivities: completedActivities,
                notes: notes,
                todos: todos,
                customActivityInputValue: customActivityName // Save the input field value too
            };

            try {
                localStorage.setItem(LOCAL_STORAGE_PREFIX + dateString, JSON.stringify(stateForDate));
                console.log(`State saved for date: ${dateString}`);

                // NEW: Update datesWithActivity list if this date now has data
                const hasData = completedActivities.length > 0 || todos.length > 0 || notes.trim() !== '';
                const index = datesWithActivity.indexOf(dateString);
                if (hasData && index === -1) {
                    datesWithActivity.push(dateString);
                } else if (!hasData && index !== -1) {
                    datesWithActivity.splice(index, 1); // Remove if data was deleted
                }
                 saveGlobalState(); // Save global state (which includes datesWithActivity)

            } catch (e) {
                console.error("Error saving state for date:", e);
                alert("Error saving data for this date. Local storage might be full.");
            }
        }

        function loadStateForDate(dateString) {
            console.log(`Loading state for date: ${dateString}`);
            // --- Load Global State First (only needs to be done once, but safe to do here) ---
            const globalStateJSON = localStorage.getItem(GLOBAL_STATE_KEY);
            if (globalStateJSON) {
                try {
                    const gs = JSON.parse(globalStateJSON);
                    totalSeconds = gs.selectedTime || 1500;
                    currentActivity = gs.selectedActivity || 'work';
                    isAlarmEnabled = gs.isAlarmEnabled !== undefined ? gs.isAlarmEnabled : true; // Load alarm state, default true
                    datesWithActivity = gs.datesWithActivity || []; // Load dates list

                    // Update UI based on global state
                    updateButtonSelection(timeIntervalsDiv, `[data-time="${totalSeconds}"]`);
                    updateButtonSelection(activityTypesDiv, `[data-type="${currentActivity}"]`);
                    updateAlarmToggleUI(); // Update alarm icon

                } catch (e) {
                    console.error("Error loading global state:", e);
                    // Set defaults if loading fails
                    totalSeconds = 1500; currentActivity = 'work'; isAlarmEnabled = true; datesWithActivity = [];
                }
            } else {
                 // Set defaults if no global state saved yet
                 totalSeconds = 1500; currentActivity = 'work'; isAlarmEnabled = true; datesWithActivity = [];
                 updateButtonSelection(timeIntervalsDiv, `[data-time="1500"]`);
                 updateButtonSelection(activityTypesDiv, `[data-type="work"]`);
                 updateAlarmToggleUI();
            }
            currentSeconds = totalSeconds; // Reset timer display to loaded duration

            // --- Load State Specific to the Date ---
            const savedStateJSON = localStorage.getItem(LOCAL_STORAGE_PREFIX + dateString);
            if (savedStateJSON) {
                try {
                    const s = JSON.parse(savedStateJSON);
                    // Ensure arrays/strings are initialized correctly if saved data is malformed
                    completedActivities = Array.isArray(s.completedActivities) ? s.completedActivities : [];
                    notes = typeof s.notes === 'string' ? s.notes : '';
                    todos = Array.isArray(s.todos) ? s.todos : [];
                    customActivityName = typeof s.customActivityInputValue === 'string' ? s.customActivityInputValue : '';
                    console.log(`State loaded for ${dateString}. Activities: ${completedActivities.length}, Todos: ${todos.length}`);
                } catch (e) {
                    console.error(`Error parsing state for date ${dateString}:`, e);
                    completedActivities = []; notes = ''; todos = []; customActivityName = '';
                }
            } else {
                // No state saved for this date, reset everything
                completedActivities = []; notes = ''; todos = []; customActivityName = '';
                console.log(`No saved state found for ${dateString}. Initializing fresh state.`);
            }

            // --- Update UI ---
            notesArea.value = notes;
            customActivityNameInput.value = customActivityName;
            renderTimeline();
            renderTodos();
            updateDisplay(); // Update timer display, activity name etc.
            updateDateActivityIndicator(); // NEW: Update the dot indicator
        }

        // --- UI Update Functions ---
        function updateButtonSelection(container, selector) {
            container.querySelectorAll('button').forEach(btn => btn.classList.remove('selected-button'));
            if (selector) {
                const buttonToSelect = container.querySelector(selector);
                if (buttonToSelect) {
                    buttonToSelect.classList.add('selected-button');
                }
            }
        }

        // NEW: Update alarm toggle button appearance
        function updateAlarmToggleUI() {
            const mutedIcon = alarmToggleBtn.querySelector('.icon-muted');
            const activeIcon = alarmToggleBtn.querySelector('.icon-active');
            if (isAlarmEnabled) {
                alarmToggleBtn.classList.add('enabled');
                alarmToggleBtn.title = "Disable Alarm Sound";
                mutedIcon.style.display = 'none';
                activeIcon.style.display = 'inline';
            } else {
                alarmToggleBtn.classList.remove('enabled');
                alarmToggleBtn.title = "Enable Alarm Sound";
                mutedIcon.style.display = 'inline';
                activeIcon.style.display = 'none';
            }
        }

        // NEW: Update date activity indicator
        function updateDateActivityIndicator() {
            if (datesWithActivity.includes(selectedDate)) {
                dateActivityIndicator.textContent = 'â€¢';
                dateActivityIndicator.title = `Activity logged on ${formatDateForDisplay(selectedDate)}`;
            } else {
                dateActivityIndicator.textContent = '';
                dateActivityIndicator.title = `No activity logged for ${formatDateForDisplay(selectedDate)}`;
            }
        }


        // --- Event Listeners ---
        startStopBtn.addEventListener('click', () => {
            if (isRunning) {
                stopTimer(false); // Pause the timer
            } else {
                startTimer(); // Start or resume the timer
            }
        });

        resetBtn.addEventListener('click', resetTimer);
        stopLogBtn.addEventListener('click', stopAndLogTimer); // NEW: Listener for Stop & Log

        timeIntervalsDiv.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON' && e.target.dataset.time) {
                 if (isRunning) {
                     alert("Stop the timer before changing the duration.");
                     return;
                 }
                 totalSeconds = parseInt(e.target.dataset.time, 10);
                 currentSeconds = totalSeconds; // Reset countdown when duration changes
                 updateDisplay();
                 updateButtonSelection(timeIntervalsDiv, `[data-time="${totalSeconds}"]`);
                 saveGlobalState(); // Save new default duration
            }
        });

        activityTypesDiv.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON' && e.target.dataset.type) {
                // Allow changing activity type even while running, but maybe reset start time?
                 // For now, let's allow it without resetting timer, it just applies to the *next* log.
                 // If you want it to apply immediately or reset, add logic here.
                currentActivity = e.target.dataset.type;
                updateDisplay(); // Update the activity name display
                updateButtonSelection(activityTypesDiv, `[data-type="${currentActivity}"]`);
                if (currentActivity === 'custom') {
                    customActivityNameInput.focus(); // Focus input if custom is selected
                }
                saveGlobalState(); // Save new default activity type
            }
        });

        // Save custom activity name as it's typed (debounced)
        let customNameTimeout;
        customActivityNameInput.addEventListener('input', () => {
            customActivityName = customActivityNameInput.value; // Update state variable immediately for display
            if (currentActivity === 'custom') {
                 updateDisplay(); // Update timer display if it's currently 'Custom'
            }
            clearTimeout(customNameTimeout);
            customNameTimeout = setTimeout(() => {
                // Save the custom name input value to the current date's state
                saveStateForDate(selectedDate)
            }, 500); // Save after 500ms pause
        });

        // Save notes as they are typed (debounced)
        let notesTimeout;
        notesArea.addEventListener('input', () => {
             clearTimeout(notesTimeout);
             notesTimeout = setTimeout(() => {
                 notes = notesArea.value; // Update state variable
                 saveStateForDate(selectedDate); // Save notes to current date's state
             }, 500); // Save after 500ms pause
        });

        addTodoBtn.addEventListener('click', addTodoItem);
        newTodoInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                addTodoItem();
            }
        });

        dateSelector.addEventListener('change', (e) => {
             if (isRunning) {
                 alert("Please stop or pause the current timer before changing the date.");
                 e.target.value = selectedDate; // Revert date selector
                 return;
             }
             const newDate = e.target.value;
             if (newDate && newDate !== selectedDate) {
                 selectedDate = newDate;
                 selectedDateDisplay.textContent = formatDateForDisplay(selectedDate);
                 resetTimer(); // Reset timer state completely when changing date
                 loadStateForDate(selectedDate); // Load data for the new date
             }
        });

        // Listener for the +1m, +3m, +5m buttons
        timerDisplayArea.addEventListener('click', (e) => {
            if (e.target.classList.contains('add-time-btn') && e.target.dataset.addTime) {
                 addTimeToTimer(parseInt(e.target.dataset.addTime, 10));
            }
        });

        // NEW: Listener for Alarm Toggle
        alarmToggleBtn.addEventListener('click', () => {
            isAlarmEnabled = !isAlarmEnabled;
            updateAlarmToggleUI();
            saveGlobalState(); // Save the new alarm state globally
            console.log(`Alarm sound ${isAlarmEnabled ? 'enabled' : 'disabled'}.`);
            // Optional: Play a short sound on toggle to confirm state change
            if (isAlarmEnabled) unlockAudio(); // Try to unlock if enabling
        });

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            selectedDate = getTodayDateString(); // Ensure we start on today
            dateSelector.value = selectedDate; // Set date input to today
            dateSelector.max = selectedDate; // Prevent selecting future dates
            selectedDateDisplay.textContent = formatDateForDisplay(selectedDate);
            loadStateForDate(selectedDate); // Load today's state (includes loading global state)

            // Initial UI setup based on loaded state
            updateDisplay();
            updateAlarmToggleUI();
            updateDateActivityIndicator();
        });

    </script>

</body>
</html>
